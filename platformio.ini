; ============================================================================
; PlatformIO Project Configuration for Lumina Smart Lamp
; ============================================================================
; 
; This is an alternative to using Arduino IDE. PlatformIO offers:
; - Better dependency management
; - Built-in unit testing
; - Easier CI/CD integration
; - Multiple environment support
;
; Usage:
;   pio run           - Build firmware
;   pio run -t upload - Upload via USB
;   pio run -t uploadfs - Upload filesystem (if using SPIFFS)
;   pio test          - Run unit tests
;
; ============================================================================

[platformio]
default_envs = nodemcu

; ============================================================================
; Common settings for all environments
; ============================================================================
[common]
lib_deps = 
    adafruit/Adafruit NeoPixel @ ^1.10.0
    EEPROM
build_flags = 
    -DDEBUG_ESP_PORT=Serial
    -DDEBUG_ESP_CORE
    ; Uncomment to disable debug output in production:
    ; -DDEBUG_MODE=false

; ============================================================================
; NodeMCU Development Environment (USB upload)
; ============================================================================
[env:nodemcu]
platform = espressif8266 @ ^4.0.1
board = nodemcuv2
framework = arduino

; Serial settings
monitor_speed = 115200
monitor_filters = 
    esp8266_exception_decoder
    default
    colorize

; Upload settings
upload_speed = 115200
upload_port = /dev/ttyUSB0  ; Change to your port (COM3 on Windows)

; Build settings
board_build.f_cpu = 80000000L
board_build.flash_mode = dio
board_build.ldscript = eagle.flash.4m2m.ld  ; 4MB flash, 2MB FS, ~1MB OTA

; Dependencies
lib_deps = ${common.lib_deps}
build_flags = ${common.build_flags}

; ============================================================================
; OTA (Over-The-Air) Update Environment
; ============================================================================
[env:nodemcu_ota]
platform = espressif8266 @ ^4.0.1
board = nodemcuv2
framework = arduino

; OTA settings
upload_protocol = espota
upload_port = 192.168.1.42  ; Change to your Lumina's IP
upload_flags = 
    --auth=lumina-ota-2026
    --port=8266

; Other settings inherited from base
monitor_speed = 115200
board_build.f_cpu = 80000000L
board_build.flash_mode = dio
board_build.ldscript = eagle.flash.4m2m.ld

lib_deps = ${common.lib_deps}
build_flags = ${common.build_flags}

; ============================================================================
; Production Environment (Optimized, no debug)
; ============================================================================
[env:production]
platform = espressif8266 @ ^4.0.1
board = nodemcuv2
framework = arduino

monitor_speed = 115200
upload_speed = 921600  ; Faster upload for production

board_build.f_cpu = 80000000L
board_build.flash_mode = dio
board_build.ldscript = eagle.flash.4m2m.ld

lib_deps = ${common.lib_deps}

; Production build flags (optimized, no debug)
build_flags = 
    -DDEBUG_MODE=false
    -O2
    -DNDEBUG

; ============================================================================
; Testing Environment (For unit tests)
; ============================================================================
[env:native]
platform = native
lib_deps = 
    adafruit/Adafruit NeoPixel @ ^1.10.0
    google/googletest @ ^1.11.0
build_flags = 
    -std=c++11
    -DUNIT_TEST

; Test configuration
test_build_project_src = yes
test_ignore = test_desktop

; ============================================================================
; ESP-12E/F Environment (Bare module without USB)
; ============================================================================
[env:esp12e]
platform = espressif8266 @ ^4.0.1
board = esp12e
framework = arduino

monitor_speed = 115200
upload_speed = 115200

; For programming via external USB-to-Serial adapter
upload_protocol = esptool
upload_port = /dev/ttyUSB0

board_build.f_cpu = 80000000L
board_build.flash_mode = dio
board_build.ldscript = eagle.flash.4m2m.ld

lib_deps = ${common.lib_deps}
build_flags = ${common.build_flags}

; ============================================================================
; Additional Notes
; ============================================================================
; 
; Port Detection:
; ---------------
; Windows: COM3, COM4, etc.
; macOS: /dev/cu.usbserial-*
; Linux: /dev/ttyUSB0, /dev/ttyUSB1, etc.
;
; Find your port with: pio device list
;
; OTA Password:
; -------------
; Default: lumina-ota-2026
; Change in UpdatingState.h line 50
;
; Flash Layouts:
; --------------
; 4m2m = 4MB flash: 1MB sketch, 1MB OTA, 2MB SPIFFS
; 4m1m = 4MB flash: 1MB sketch, 1MB OTA, 1MB SPIFFS, 1MB EEPROM
;
; For smaller ESP modules:
; 1m64 = 1MB flash: 64KB SPIFFS
; 
; Memory Optimization:
; --------------------
; If you're running out of memory, try these flags:
;   -DVTABLES_IN_FLASH
;   -fno-exceptions
;   -DBEARSSL_SSL_BASIC
;
; Debugging:
; ----------
; Enable ESP8266 core debug: -DDEBUG_ESP_CORE
; Enable WiFi debug: -DDEBUG_ESP_WIFI
; Enable OTA debug: -DDEBUG_ESP_OTA
;
